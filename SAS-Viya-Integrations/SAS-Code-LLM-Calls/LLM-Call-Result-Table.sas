/*******************************************************************************
    Copyright Â© 2024, SAS Institute Inc., Cary, NC, USA.  All Rights Reserved.
    SPDX-License-Identifier: Apache-2.0

    Turns the LLM response into a table for tracking

    This script is meant to be run after the result code
      that is generated by the script Get-LLM-Options.sas

    The output table is called:
      work._crt_result_table

    crt is short for:
      Create Result Tracking
*******************************************************************************/
* Provide the LLM name;
%let _crt_LLM_name = ;
* Set the n-th run id;
%let _crt_runID = 1;
* Set the n-th model within a run;
%let _crt_counter = 1;

* Recast the options object to work as a table input;
%let _crt_options = %str(%')&options.%str(%');

data work._crt_result_table_&_crt_runID._&_crt_counter.;
    length runId 8. systemPrompt userPrompt $32767. model $100. options $1000. response $32767. run_time prompt_length output_length best_prompt 8.;
    runId = &_crt_runID.;
    systemPrompt = "&systemPrompt.";
    userPrompt = "&userPrompt.";
	if _n_ = 1 then output;
    set llmOut.data(drop=ordinal_root ordinal_data);
	systemPrompt = '';
	userPrompt = '';
    model = "&_crt_LLM_name.";
    options = "'" || substr("%superq(_crt_options)", 29, length("%superq(_crt_options)") - 31) || "'";
	output;
run;

* Clean up;
libname llmOut clear;
filename llmOut clear;
%symdel _crt_LLM_name _crt_runID _crt_counter _crt_options;