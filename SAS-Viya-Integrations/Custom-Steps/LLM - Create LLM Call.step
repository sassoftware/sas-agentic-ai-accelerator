{"creationTimeStamp":"2024-08-05T08:20:25.154Z","modifiedTimeStamp":"2024-08-07T16:02:26.095Z","createdBy":"gerdaw","modifiedBy":"gerdaw","name":"LLM - Create LLM Call.step","displayName":"LLM - Create LLM Call.step","localDisplayName":"LLM - Create LLM Call.step","description":"Performs a look up of the options for a specific LLM and generates corresponding code to interact with the model","localDescription":"Performs a look up of the options for a specific LLM and generates corresponding code to interact with the model","properties":{},"links":[{"method":"GET","rel":"self","href":"/dataFlows/steps/59f75716-d9ef-47a9-938e-292f209ecd12","uri":"/dataFlows/steps/59f75716-d9ef-47a9-938e-292f209ecd12","type":"application/vnd.sas.data.flow.step"},{"method":"GET","rel":"alternate","href":"/dataFlows/steps/59f75716-d9ef-47a9-938e-292f209ecd12","uri":"/dataFlows/steps/59f75716-d9ef-47a9-938e-292f209ecd12","type":"application/vnd.sas.data.flow.step.summary"},{"method":"GET","rel":"up","href":"/dataFlows/steps","uri":"/dataFlows/steps","type":"application/vnd.sas.collection","itemType":"application/vnd.sas.data.flow.step.summary"},{"method":"PUT","rel":"update","href":"/dataFlows/steps/59f75716-d9ef-47a9-938e-292f209ecd12","uri":"/dataFlows/steps/59f75716-d9ef-47a9-938e-292f209ecd12","type":"application/vnd.sas.data.flow.step","responseType":"application/vnd.sas.data.flow.step"},{"method":"DELETE","rel":"delete","href":"/dataFlows/steps/59f75716-d9ef-47a9-938e-292f209ecd12","uri":"/dataFlows/steps/59f75716-d9ef-47a9-938e-292f209ecd12"},{"method":"POST","rel":"copy","href":"/dataFlows/steps/59f75716-d9ef-47a9-938e-292f209ecd12/copy","uri":"/dataFlows/steps/59f75716-d9ef-47a9-938e-292f209ecd12/copy","responseType":"application/vnd.sas.data.flow.step"},{"method":"GET","rel":"transferExport","href":"/dataFlows/steps/59f75716-d9ef-47a9-938e-292f209ecd12","uri":"/dataFlows/steps/59f75716-d9ef-47a9-938e-292f209ecd12","responseType":"application/vnd.sas.transfer.object"},{"method":"PUT","rel":"transferImportUpdate","href":"/dataFlows/steps/59f75716-d9ef-47a9-938e-292f209ecd12","uri":"/dataFlows/steps/59f75716-d9ef-47a9-938e-292f209ecd12","type":"application/vnd.sas.transfer.object","responseType":"application/vnd.sas.summary"}],"metadataVersion":0.0,"version":2,"type":"code","flowMetadata":{"inputPorts":[{"name":"_slo_mod_input","displayName":"_slo_mod_input","localDisplayName":"_slo_mod_input","minEntries":0,"maxEntries":1,"defaultEntries":0,"type":"table"}],"outputPorts":[]},"ui":"{\n\t\"showPageContentOnly\": true,\n\t\"pages\": [\n\t\t{\n\t\t\t\"id\": \"pageDefinition\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"Definition\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_slo_info_text\",\n\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\"text\": \"Specify a SAS Model Manager model name and the corresponding options file URI.\\n\\nIf you select a model name from a table it is assumed that the same table has a column called optionsFileURI, which is consistent with the output from the step LLM - List Available LLMs.\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_slo_input_selector\",\n\t\t\t\t\t\"type\": \"radiogroup\",\n\t\t\t\t\t\"label\": \"Choose how to enter the model name/optionsFileURI:\",\n\t\t\t\t\t\"items\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"table\",\n\t\t\t\t\t\t\t\"label\": \"Select name from a table\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"value\": \"manual\",\n\t\t\t\t\t\t\t\"label\": \"Input an name and optionsFileURI manually\"\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_slo_mod_input\",\n\t\t\t\t\t\"type\": \"inputtable\",\n\t\t\t\t\t\"label\": \"Model table:\",\n\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"visible\": [\n\t\t\t\t\t\t\"$_slo_input_selector\",\n\t\t\t\t\t\t\"=\",\n\t\t\t\t\t\t\"table\"\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_slo_col\",\n\t\t\t\t\t\"type\": \"columnselector\",\n\t\t\t\t\t\"label\": \"Select model name column:\",\n\t\t\t\t\t\"include\": null,\n\t\t\t\t\t\"order\": false,\n\t\t\t\t\t\"columntype\": \"c\",\n\t\t\t\t\t\"max\": 1,\n\t\t\t\t\t\"min\": null,\n\t\t\t\t\t\"visible\": [\n\t\t\t\t\t\t\"$_slo_input_selector\",\n\t\t\t\t\t\t\"=\",\n\t\t\t\t\t\t\"table\"\n\t\t\t\t\t],\n\t\t\t\t\t\"readonly\": false,\n\t\t\t\t\t\"table\": \"_slo_mod_input\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_slo_mod_nm_tab\",\n\t\t\t\t\t\"type\": \"list\",\n\t\t\t\t\t\"label\": \"Select the model name:\",\n\t\t\t\t\t\"items\": {\n\t\t\t\t\t\t\"ref\": \"_slo_col\"\n\t\t\t\t\t},\n\t\t\t\t\t\"max\": 1,\n\t\t\t\t\t\"min\": null,\n\t\t\t\t\t\"visible\": [\n\t\t\t\t\t\t\"$_slo_input_selector\",\n\t\t\t\t\t\t\"=\",\n\t\t\t\t\t\t\"table\"\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_slo_mod_name_manual\",\n\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\"label\": \"Enter a model name:\",\n\t\t\t\t\t\"placeholder\": \"Model name\",\n\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\"visible\": [\n\t\t\t\t\t\t\"$_slo_input_selector\",\n\t\t\t\t\t\t\"=\",\n\t\t\t\t\t\t\"manual\"\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_slo_fl_uri_manual\",\n\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\"label\": \"Enter a options file URI:\",\n\t\t\t\t\t\"placeholder\": \"/files/files/<uui>\",\n\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\"visible\": [\n\t\t\t\t\t\t\"$_slo_input_selector\",\n\t\t\t\t\t\t\"=\",\n\t\t\t\t\t\t\"manual\"\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_slo_LLMSCR\",\n\t\t\t\t\t\"type\": \"textfield\",\n\t\t\t\t\t\"label\": \"Specify the LLM-SCR endpoint to call:\",\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"required\": true,\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_slo_fl\",\n\t\t\t\t\t\"type\": \"checkbox\",\n\t\t\t\t\t\"label\": \"Save the code to a filename?\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_slo_fl_path\",\n\t\t\t\t\t\"type\": \"path\",\n\t\t\t\t\t\"label\": \"Choose a path, where to store the filename, if left empty it will be set to temp:\",\n\t\t\t\t\t\"pathtype\": \"file\",\n\t\t\t\t\t\"placeholder\": \"\",\n\t\t\t\t\t\"required\": false,\n\t\t\t\t\t\"visible\": \"$_slo_fl\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"_slo_result\",\n\t\t\t\t\t\"type\": \"checkbox\",\n\t\t\t\t\t\"label\": \"Print the code to the Results tab?\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\t\t{\n\t\t\t\"id\": \"pageAbout\",\n\t\t\t\"type\": \"page\",\n\t\t\t\"label\": \"About\",\n\t\t\t\"children\": [\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"textAbout\",\n\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\"text\": \"LLM - Create LLM Call step\\n==========\\n\\nThe \\\"LLM - Create LLM Call\\\" custom steps performs a look up of the options for a specific LLM and generates corresponding code to call the model with the model default options.\\n\\nIt is possible to save the resulting code to a file or printing it to the Results pane.\",\n\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"sectionPrereqs\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Pre-requisites\",\n\t\t\t\t\t\"open\": false,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"textPrereqs\",\n\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\"text\": \"Pre-requisites:  Tested on Viya version Stable 2024.07\\n\\nSAS Model Manager has be licensed and the user has to have the capability to use SAS Model Manager.\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"sectionDocumentation\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Documentation\",\n\t\t\t\t\t\"open\": false,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"textDocumentation\",\n\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\"text\": \"* The following SAS Viya REST-API are used:\\nhttps://developer.sas.com/rest-apis/files-v9?operation=getfileContentForGivenId\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"id\": \"sectionChangelog\",\n\t\t\t\t\t\"type\": \"section\",\n\t\t\t\t\t\"label\": \"Changelog\",\n\t\t\t\t\t\"open\": true,\n\t\t\t\t\t\"visible\": \"\",\n\t\t\t\t\t\"children\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"id\": \"textChangelog\",\n\t\t\t\t\t\t\t\"type\": \"text\",\n\t\t\t\t\t\t\t\"text\": \"* Version: 1.0 (07AUG2024)\\n      - Initial version\",\n\t\t\t\t\t\t\t\"visible\": \"\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t],\n\t\"syntaxversion\": \"1.3.0\",\n\t\"values\": {\n\t\t\"_slo_input_selector\": {\n\t\t\t\"value\": \"table\",\n\t\t\t\"label\": \"Select name from a table\"\n\t\t},\n\t\t\"_slo_LLMSCR\": \"%sysfunc(getoption(SERVICESBASEURL))/llm\",\n\t\t\"_slo_fl\": true,\n\t\t\"_slo_fl_path\": \"\",\n\t\t\"_slo_result\": true\n\t}\n}","templates":{"SAS":"/**************************************************************\n    Retrieves options for a LLM call and generates it\n\n    slo is short for:\n      SAS Large Language Model Options\n**************************************************************/\n* Get the Viya Host URL;\n%let _slo_viyaHost=%sysfunc(getoption(SERVICESBASEURL));\n\n%if &_slo_input_selector. EQ table %then %do;\n    %let _slo_LLM_name = &_slo_mod_nm_tab_1.;\n    proc sql noPrint;\n        select optionsFileURI into :_slo_optionsFileURI\n            from &_slo_mod_input.\n                where name EQ \"&_slo_LLM_name.\";\n    run; quit;\n%end;\n%else %do;\n    %let _slo_LLM_name = &_slo_mod_name_manual.;\n    %let _slo_optionsFileURI = &_slo_fl_uri_manual.;\n%end;\n\n* Get the Viya Host URL;\n%let _slo_viyaHost=%sysfunc(getoption(SERVICESBASEURL));\n\nfilename _slo_rsp temp;\n\n* https://developer.sas.com/rest-apis/files-v9?operation=getfileContentForGivenId;\nproc http\n    method='Get'\n    url=\"&_slo_viyaHost.&_slo_optionsFileURI./content\"\n    oauth_bearer=sas_services\n    out=_slo_rsp;\n    headers 'Accept' = 'application/json';\nrun; quit;\n\nlibname _slo_rsp json;\n\n* Order the data set to be able to transpose it;\nproc sql;\n    create table work._slo_alldata as\n        select *\n            from _slo_rsp.alldata\n                where v=1\n                    order by P1, P2;\nrun; quit;\n\n* Flatten the output table structure;\nproc transpose data=work._slo_alldata out=work._slo_transposed(drop=_name_) prefix=col_;\n    by P1;\n    id P2;\n    var Value;\nrun; quit;\n\n* Give meaningful names;\ndata work._slo_options;\n    set work._slo_transposed;\n    rename p1 = option_name\n      col_default = default\n      col_range = range\n      col_description = description;\nrun;\n\n* Create code that generates the option inputs;\ndata work._slo_final_macro_vars;\n    length _slo_code $32767.;\n    set work._slo_options;\n\n    * Create macro variables that the user can set;\n    _slo_code = '%let ' || compress(option_name) || '=' || compress(default) || ';';\n    keep _slo_code;\nrun;\n\n* Create code that generates the JSON input;\ndata work._slo_final_json_input;\n    length _slo_code $32767.;\n    set work._slo_options end=EoF;\n\n    if _n_ = 1 then do;\n        _slo_code = '%let systemPrompt=Your system prompt;';\n        output;\n        _slo_code = '%let userPrompt=Your user prompt;';\n        output;\n        _slo_code = 'filename llmIn temp;';\n        output;\n        _slo_code = 'data _null_;';\n        output;\n        _slo_code = 'length _slo_code $32767.;';\n        output;\n        _slo_code = 'file llmIn;';\n        output;\n        _slo_code = 'put ' || \"'{\" || '\"inputs\": [' || \"';\";\n        output;\n        _slo_code = 'put ' || \"'{\" || '\"name\": \"systemPrompt\", ' || \"';\";\n        output;\n        _slo_code = \"_slo_code =  '\" || '\"value\": \"' || \"' || \" || '\"&systemPrompt.\" || ' || \"'\" || '\"},' || \"';\";\n        output;\n        _slo_code = 'put _slo_code;';\n        output;\n        _slo_code = 'put ' || \"'{\" || '\"name\": \"userPrompt\", ' || \"';\";\n        output;\n        _slo_code = \"_slo_code =  '\" || '\"value\": \"' || \"' || \" || '\"&userPrompt.\" || ' || \"'\" || '\"},' || \"';\";\n        output;\n        _slo_code = 'put _slo_code;';\n        output;\n        _slo_code = \"_slo_code='{\" || '\"name\": \"options\", \"value\": \"{' || \"';\";\n        output;\n    end;\n\n    if eof then do;\n        _slo_code = '_slo_code = compress(_slo_code) ||\"' || compress(option_name) || ':\"|| \"&' || compress(option_name) || '.\"' || \"||'\" || '}\"' || \"'\" || ';';\n        output;\n        _slo_code = 'put _slo_code;';\n        output;\n        _slo_code = 'call symputx(\"options\", compress(_slo_code) || \"}\");';\n        output;\n        _slo_code = \"put '}';\";\n        output;\n        _slo_code = 'put \"]}\";';\n        output;\n        _slo_code = 'run;';\n        output;\n    end;\n    else do;\n        _slo_code = '_slo_code = compress(_slo_code) ||\"' || compress(option_name) || ':\"|| \"&' || compress(option_name) || '.,\";';\n        output;\n    end;\n\n    keep _slo_code;\nrun;\n\n* Create code that generates the HTTP call;\ndata work._slo_final_http;\n    length _slo_code $32767.;\n    _slo_code = 'filename llmOut temp;';\n    output;\n    _slo_code = 'proc http';\n    output;\n    _slo_code = \"method='Post'\";\n    output;\n    _slo_code = 'url=\"' || \"&_slo_LLMSCR./\" || compress(\"&_slo_LLM_name./&_slo_LLM_name.\") || '\"';\n    output;\n    _slo_code = 'in=llmIn';\n    output;\n    _slo_code = \"ct='application/json'\";\n    output;\n    _slo_code = 'out=llmOut;';\n    output;\n    _slo_code = 'run; quit;';\n    output;\n    _slo_code = 'libname llmOut json;';\n    output;\nrun;\n\n* Combine the datasets;\ndata work._slo_final;\n    set work._slo_final_macro_vars work._slo_final_json_input work._slo_final_http;\nrun;\n\n* Save the result as a filename;\n%if &_slo_fl. EQ 1 %then %do;\n    data _null_;\n        if \"&_slo_fl_path.\" EQ '' then do;\n            putLog 'ERROR: No path specified to save the script to';\n\t\t\tabort 42;\n        end;\n        else do;\n            justFileName = scan(\"&_slo_fl_path.\", -1, '/', 'MO');\n            folderPath1 = scan(\"&_slo_fl_path.\", 2, ':', 'MO');\n            folderPath2 = substr(folderPath1, 1, length(folderPath1) - length(justFileName) - 1);\n            mode = scan(\"&_slo_fl_path.\", 1, ':', 'MO');\n\n            * Handle the different required filename for SAS Content and SAS Server;\n            if mode = 'sascontent' then do;\n                call symput('_slo_fl_path', \"filename _slo_LLM filesrvc folderPath='\" || strip(folderPath2) || \"' filename='\" || strip(justFileName) || \"'\");\n            end;\n            else do;\n                call symput('_slo_fl_path', \"filename _slo_LLM '\" || strip(folderPath1) || \"'\");\n            end;\n        end;\n    run;\n\n\t&_slo_fl_path.;\n\n    data _null_;\n        file _slo_LLM;\n        set work._slo_final;\n        put _slo_code;\n    run;\n\n\tfilename _slo_LLM clear;\n%end;\n\n* Print the result for the user;\n%if &_slo_result. EQ 1 %then %do;\n    title 'Copy & paste this code into a SAS script';\n    proc print data=work._slo_final noObs;\n    run; quit;\n    title;\n%end;\n\n* Clean up;\nlibname _slo_rsp clear;\nfilename _slo_rsp clear;\nproc datasets library=work noList;\n    delete _slo_alldata _slo_transposed _slo_options _slo_final_macro_vars _slo_final_json_input _slo_final_http _slo_final;\nrun; quit;\n%symdel _slo_LLM_name _slo_optionsFileURI _slo_viyaHost;"}}